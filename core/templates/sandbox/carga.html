{% extends "base.html" %}
{# -------------------------------------------------------------------------
   SANDBOX DE CARGA (CSV o PDF Cert70)
   - GET  : muestra el formulario para subir archivo
   - POST : muestra vista previa (inyectada por la view como "preview_rows")
   La view guarda en sesión la preview y aquí solo se confirma el guardado.
   ------------------------------------------------------------------------- #}

{% block main %}
<div class="container py-3">

  {# Barra superior: volver al dashboard #}
  <div class="d-flex justify-content-end mb-2">
    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-sm">
      ← Volver al Dashboard
    </a>
  </div>

  <h5 class="mb-3">Sandbox de Carga (CSV / PDF Cert70)</h5>

  {# -------------------- FORMULARIO DE SUBIDA ---------------------------- #}
  <div class="card mb-3">
    <div class="card-body">
      <p class="text-muted mb-2">
        Sube un <code>.csv</code> (plantilla por Monto o por Factor) o un <code>.pdf</code> con layout Cert70.
      </p>

      {# IMPORTANTE: method + enctype para subir archivos #}
      <form method="post" enctype="multipart/form-data" action="{% url 'sandbox_carga' %}">
        {% csrf_token %}
        <div class="row g-2 align-items-center flex-wrap">
          <div class="col-auto">
            <input type="file" name="archivo" class="form-control form-control-sm"
                   style="max-width: 320px" accept=".csv,.pdf" required>
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-primary btn-sm">Procesar archivo</button>
          </div>
        </div>

        {# Nota simple (sin enlaces estáticos) para recordar el formato del CSV #}
        <div class="mt-2 small text-muted">
          <strong>Formato CSV recomendado:</strong> columnas base
          <code>EJERCICIO</code>, <code>MERCADO_COD</code>, <code>NEMO</code>,
          <code>FEC_PAGO</code>, <code>SEC_EVE</code>, <code>DESCRIPCION</code>,
          <code>TIPO_INGRESO_ID</code> y luego <code>F8_MONTO..F37_MONTO</code>
          <em>o</em> <code>F8_FACTOR..F37_FACTOR</code>.
        </div>
      </form>
    </div>
  </div>

  {# -------------------- VISTA PREVIA (si la hay) ------------------------ #}
  {% if preview_rows %}
    {# Banner con totales básicos que envía la view #}
    <div class="alert alert-info d-flex justify-content-between align-items-center">
      <div>
        <strong>Vista previa generada.</strong>
        Modo: <code>{{ modo_detectado }}</code>.
        Total filas: <strong>{{ total }}</strong> &middot;
        Nuevos: <strong>{{ nuevos }}</strong> &middot;
        Actualiza: <strong>{{ actualiza }}</strong>
      </div>
      <form method="post" action="{% url 'sandbox_carga_confirm' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-success btn-sm">Grabar</button>
        <a href="{% url 'sandbox_carga' %}" class="btn btn-outline-secondary btn-sm">Cancelar</a>
      </form>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Ejercicio</th>
                <th>Mercado</th>
                <th>Fecha Pago</th>
                <th>Sec_Eve</th>
                <th>Descripción</th>
                <th class="text-center">Factores con valor</th>
                <th class="text-center">Suma 8–19</th>
                <th class="text-center">Estado</th>
              </tr>
            </thead>
            <tbody>
              {% for r in preview_rows %}
                <tr>
                  <td class="text-muted">{{ forloop.counter }}</td>
                  <td>{{ r.ejercicio }}</td>
                  <td>{{ r.mercado_cod }}</td>
                  <td>{{ r.fecha_pago }}</td>
                  <td>{{ r.sec_eve }}</td>
                  <td>{{ r.descripcion }}</td>
                  <td class="text-center">
                    {{ r.factores_con_valor|default:"0" }}
                  </td>
                  <td class="text-center">
                    {{ r.suma_8_19|default:"0" }}
                  </td>
                  <td class="text-center">
                    {% if r.status == 'nuevo' %}
                      <span class="badge bg-success">Nuevo</span>
                    {% elif r.status == 'actualiza' %}
                      <span class="badge bg-warning text-dark">Actualiza</span>
                    {% else %}
                      <span class="badge bg-secondary">—</span>
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="9" class="text-center text-muted">Sin filas</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {# Leyenda rápida del modo detectado #}
        <div class="small text-muted">
          <strong>Nota:</strong> Si el archivo contiene columnas <code>F*_MONTO</code>,
          el sistema calcula factores proporcionales. Si contiene <code>F*_FACTOR</code>,
          se toman esos valores directamente (validando que la suma 8–19 ≤ 1.0).
        </div>
      </div>
    </div>
  {% endif %}

</div>
{% endblock %}
