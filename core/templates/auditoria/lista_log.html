{% extends "base.html" %}
{% load tz %}

{% block main %}
<style>
  .audit-sticky { position: sticky; top: 0; z-index: 100; background: var(--bs-body-bg,#fff); }
  .codebox { max-height: 260px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
  .timeline-dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
  .badge-op { min-width: 68px; }
  .stat-card { border-radius: 14px; }
</style>

<div class="container py-3">

  <!-- Barra superior de acciones -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">üìú Auditor√≠a (Base de Datos)</h3>
    <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-secondary">‚Üê Volver al Dashboard</a>
  </div>

  <!-- PANEL DE M√âTRICAS -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="stat-card p-3 shadow-sm bg-light">
        <div class="text-muted small">Usuarios activos</div>
        <div class="fs-3 fw-semibold">{{ active_users_count }}</div>
        {% if active_users and active_users_count > 0 %}
          <div class="small text-truncate">({{ active_users|join:", " }})</div>
        {% endif %}
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card p-3 shadow-sm bg-light">
        <div class="text-muted small">Operaciones (total)</div>
        <div class="fs-3 fw-semibold">{{ total_ops }}</div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="stat-card p-3 shadow-sm bg-light">
        <div class="text-muted small mb-1">Por tipo</div>
        <div class="d-flex gap-2 flex-wrap">
          <span class="badge bg-success">A√±adidos {{ count_I }}</span>
          <span class="badge bg-warning text-dark">Modificaciones {{ count_U }}</span>
          <span class="badge bg-danger">Eliminaciones {{ count_D }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="audit-sticky pb-2 pt-1">
    <form class="row g-2 align-items-end" method="get">
      <div class="col-md-2">
        <label class="form-label form-label-sm">Operaci√≥n</label>
        <select name="op" class="form-select form-select-sm">
          <option value="">Todas</option>
          <option value="I" {% if op == 'I' %}selected{% endif %}>A√±adidos</option>
          <option value="U" {% if op == 'U' %}selected{% endif %}>Modificaciones</option>
          <option value="D" {% if op == 'D' %}selected{% endif %}>Eliminaciones</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label form-label-sm">Tipo de ingreso</label>
        <select name="origen" class="form-select form-select-sm">
          <option value="">Todos</option>
          <option value="manual" {% if origen == 'manual' %}selected{% endif %}>Carga manual (Corredor)</option>
          <option value="masiva" {% if origen == 'masiva' %}selected{% endif %} disabled title="Pronto">
            Carga masiva (Archivo)
          </option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label form-label-sm">Desde</label>
        <input type="date" class="form-control form-control-sm" name="fi" value="{{ fi }}">
      </div>
      <div class="col-md-2">
        <label class="form-label form-label-sm">Hasta</label>
        <input type="date" class="form-control form-control-sm" name="ff" value="{{ ff }}">
      </div>

      <div class="col-md-4 d-flex gap-2">
        <button class="btn btn-sm btn-primary">Filtrar</button>
        <a class="btn btn-sm btn-outline-secondary" href="?">Limpiar</a>
      </div>
    </form>
    <hr class="mt-2 mb-0">
  </div>

  {% if page_obj.paginator.count == 0 %}
    <div class="alert alert-light mt-3">Sin resultados</div>
  {% endif %}

  <!-- LISTA AGRUPADA (siempre por Calificaci√≥n PK) -->
  <div class="accordion mt-3" id="auditAccordion">
    {% for g in page_obj.object_list %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="h{{ forloop.counter }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c{{ forloop.counter }}">
            <div class="d-flex flex-column">
              <strong>{{ g.title }}</strong>
              <small class="text-muted">
                {{ g.count }} evento{% if g.count != 1 %}s{% endif %} ‚Ä¢
                {{ g.first_when|localtime|date:"M d, Y, g:i a" }} ‚Üí {{ g.last_when|localtime|date:"M d, Y, g:i a" }}
              </small>
            </div>
          </button>
        </h2>
        <div id="c{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#auditAccordion">
          <div class="accordion-body p-0">
            <table class="table table-sm mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width: 200px;">Fecha</th>
                  <th style="width: 90px;">Op</th>
                  <th>Actor</th>
                  <th style="width: 110px;">IP</th>
                  <th style="width: 320px;">Request ID</th>
                  <th style="width: 140px;">Detalle</th>
                </tr>
              </thead>
              <tbody>
                {% for r in g.items %}
                <tr>
                  <td><span class="timeline-dot bg-secondary"></span>{{ r.when|localtime|date:"M d, Y, g:i:s a" }}</td>
                  <td><span class="badge badge-op bg-{{ r.op_color }}">{{ r.op_label }}</span></td>
                  <td>{{ r.actor }} <small class="text-muted">({{ r.db_user }})</small></td>
                  <td><small>{{ r.ip }}</small></td>
                  <td><code class="text-break">{{ r.rid }}</code></td>
                  <td>
                    {% if r.op == 'U' %}
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-dark" data-bs-toggle="collapse" data-bs-target="#b{{ forloop.parentloop.counter }}{{ forloop.counter }}">Antes</button>
                        <button class="btn btn-outline-dark" data-bs-toggle="collapse" data-bs-target="#a{{ forloop.parentloop.counter }}{{ forloop.counter }}">Despu√©s</button>
                      </div>
                    {% elif r.op == 'I' %}
                      <button class="btn btn-sm btn-outline-dark" data-bs-toggle="collapse" data-bs-target="#a{{ forloop.parentloop.counter }}{{ forloop.counter }}">Antes</button>
                    {% else %}
                      <button class="btn btn-sm btn-outline-dark" data-bs-toggle="collapse" data-bs-target="#b{{ forloop.parentloop.counter }}{{ forloop.counter }}">Despu√©s</button>
                    {% endif %}
                  </td>
                </tr>

                {% if r.before %}
                <tr class="collapse" id="b{{ forloop.parentloop.counter }}{{ forloop.counter }}">
                  <td colspan="6">
                    <div class="codebox border rounded p-2 bg-light"><pre class="mb-0"><code>{{ r.before }}</code></pre></div>
                  </td>
                </tr>
                {% endif %}

                {% if r.after %}
                <tr class="collapse" id="a{{ forloop.parentloop.counter }}{{ forloop.counter }}">
                  <td colspan="6">
                    <div class="codebox border rounded p-2 bg-light"><pre class="mb-0"><code>{{ r.after }}</code></pre></div>
                  </td>
                </tr>
                {% endif %}
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- PAGINACI√ìN -->
  {% if page_obj.paginator.num_pages > 1 %}
    <nav class="mt-3">
      <ul class="pagination pagination-sm">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ page_obj.previous_page_number }}&op={{ op }}&origen={{ origen }}&fi={{ fi }}&ff={{ ff }}">¬´</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">¬´</span></li>
        {% endif %}
        <li class="page-item disabled">
          <span class="page-link">P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
        </li>
        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ page_obj.next_page_number }}&op={{ op }}&origen={{ origen }}&fi={{ fi }}&ff={{ ff }}">¬ª</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">¬ª</span></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
</div>
{% endblock %}
