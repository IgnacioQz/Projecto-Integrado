{% extends "base.html" %}
{% load static %}

{% block main %}
<div class="container my-4">

  <!-- ===========================================
       Encabezado / contexto de la calificaci√≥n
       =========================================== -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">
      Calificaci√≥n #{{ calif.pk }}
      <small class="text-muted">‚Äî {{ calif.instrumento_text }} ({{ calif.ejercicio }})</small>
    </h3>
    <div>
      <a href="{% url 'main' %}" class="btn btn-outline-secondary btn-sm">‚Üê Volver al Mantenedor</a>
    </div>
  </div>

  <!-- Metadatos √∫tiles (opcional) -->
  <div class="row g-3 mb-3">
    <div class="col-sm-6 col-md-3">
      <div class="small text-muted">Mercado</div>
      <div class="fw-semibold">{{ calif.mercado }}</div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="small text-muted">Tipo Ingreso</div>
      <div class="fw-semibold">{{ calif.tipo_ingreso }}</div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="small text-muted">Fecha Pago</div>
      <div class="fw-semibold">{{ calif.fecha_pago_dividendo }}</div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="small text-muted">Secuencia Evento</div>
      <div class="fw-semibold">{{ calif.secuencia_evento }}</div>
    </div>
  </div>

  <!-- ===========================================
       Mensajes (√©xito / error / info)
       =========================================== -->
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'secondary' }} py-2 mb-2">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- ===========================================
       Formulario de montos (posiciones 8..37)
       - El label de cada campo ya incluye ‚Äúpos ‚Äî nombre‚Äù (MontosForm)
       - Se muestran errores de validaci√≥n por campo
       =========================================== -->
  <form method="post" novalidate>
    {% csrf_token %}

    <!-- Errores generales del formulario -->
    {% if montos_form.non_field_errors %}
      <div class="alert alert-danger">
        {{ montos_form.non_field_errors }}
      </div>
    {% endif %}

    <div class="card shadow-sm mb-3">
      <div class="card-header py-2">
        <strong>Montos por factor</strong>
        <span class="text-muted small d-block">Ingrese valores para posiciones 8..37. El denominador es la suma de 8..19.</span>
      </div>
      <div class="card-body p-0">

        <!-- Tabla de entrada de montos -->
        <div class="table-responsive">
          <table class="table table-sm m-0 align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 55%;">Posici√≥n / Nombre del factor</th>
                <th style="width: 25%;">Monto</th>
                <th style="width: 20%;">Errores</th>
              </tr>
            </thead>
            <tbody>
              {% for field in montos_form %}
                <tr>
                  <td>
                    <label class="form-label m-0">{{ field.label }}</label>
                    {% if field.help_text %}
                      <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                  </td>
                  <td style="max-width: 260px;">{{ field }}</td>
                  <td class="text-danger small">
                    {% for err in field.errors %}‚Ä¢ {{ err }}<br>{% endfor %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
      <div class="modal-footer">
      <!-- Bot√≥n para cancelar y eliminar borrador -->
        <button type="submit" 
                name="action" 
                value="cancelar" 
                class="btn-modal btn-danger"
                onclick="return confirm('‚ö†Ô∏è ¬øDescartar esta calificaci√≥n incompleta? Se eliminar√° de la base de datos.')">
          üóëÔ∏è Cancelar y Eliminar
        </button>
      
        <button type="submit" 
                name="action" 
                value="calcular" 
                class="btn-modal btn-secondary">
            üßÆ Calcular
        </button>
      
        <button type="submit" 
                name="action" 
                value="guardar" 
                class="btn-modal btn-primary">
            üíæ Guardar
        </button>
      </div>
    </div>
  </form>

  <!-- ===========================================
       Resultados (s√≥lo visibles tras "Calcular" o error de suma > 1)
       - 'factores' y 'total' los env√≠a la vista cuando calcula
       =========================================== -->
  {% if factores %}
    <div class="card shadow-sm">
      <div class="card-header py-2">
        <strong>Resultados calculados</strong>
        <span class="text-muted small d-block">Total base (suma montos 8..19): {{ total }}</span>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm m-0 align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 8%;">Pos</th>
                <th>Nombre del factor</th>
                <th style="width: 20%;">Monto</th>
                <th style="width: 20%;">Factor</th>
              </tr>
            </thead>
            <tbody>
              {# 'factores' es un dict {pos: {"nombre", "monto", "factor"}} #}
              {% for pos, row in factores.items %}
                <tr>
                  <td>{{ pos }}</td>
                  <td>{{ row.nombre }}</td>
                  <td>{{ row.monto }}</td>
                  <td>{{ row.factor }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer">
        <span class="small text-muted">
          Validaci√≥n: suma de factores 8..19 ‚â§ <code>1.00000000</code>.  
          Los factores se redondean a 8 decimales con HALF_UP.
        </span>
      </div>
    </div>
  {% endif %}

</div>
{% endblock %}
