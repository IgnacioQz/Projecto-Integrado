{% extends "base.html" %}
{% load static %}

{% block title %}<title>{{ page_title|default:"Carga de Calificaciones" }}</title>{% endblock %}
{% block styles %}<link rel="stylesheet" href="{% static 'css/cargaMasiva.css' %}">{% endblock %}

{% block main %}
<div class="modal-overlay">
  <div class="modal-container-upload">

    <div class="modal-header">
      <h2>{{ header_title|default:"ğŸ“ Carga de Calificaciones" }}</h2>
      <p class="modal-subtitle">{{ header_subtitle|default:"CSV por montos/factores o PDF (Cert70)" }}</p>
    </div>

    <div class="modal-body">
      <div class="upload-section">
        <form id="uploadForm" method="post" enctype="multipart/form-data" action="{% url 'carga_archivo' %}">
          {% csrf_token %}
          <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">ğŸ“‚</div>
            <h3>Arrastre su archivo aquÃ­</h3>
            <p>o haga clic para seleccionar (.csv o .pdf)</p>
            <input type="file" name="archivo" id="fileInput" accept=".csv,.pdf" hidden required>
            <button type="button" class="btn-select-file" id="btnSelectFile">Seleccionar Archivo</button>
          </div>
        </form>
      </div>

      {% if preview_rows %}
        <div class="file-info">
          <div class="file-info-content">
            <div class="file-icon">ğŸ“„</div>
            <div class="file-details">
              <h4>{{ archivo_nombre }}</h4>
              <p>{{ total }} registro(s) â€” tipo: <code>{{ tipo_archivo }}</code>{% if modo_detectado %} â€” modo: <code>{{ modo_detectado }}</code>{% endif %}</p>
            </div>
            <button type="button" class="btn-remove-file" id="btnRemoveFile">âœ•</button>
          </div>
        </div>

        <div class="validation-section">
          <h3 class="section-title">ğŸ” ValidaciÃ³n</h3>
          <div class="validation-stats">
            <div class="stat-card stat-total"><div class="stat-number">{{ total }}</div><div class="stat-label">Total</div></div>
            <div class="stat-card stat-valid"><div class="stat-number">{{ validos }}</div><div class="stat-label">VÃ¡lidos</div></div>
            <div class="stat-card stat-warning"><div class="stat-number">{{ advertencias }}</div><div class="stat-label">Advertencias</div></div>
            <div class="stat-card stat-error"><div class="stat-number">{{ errores }}</div><div class="stat-label">Errores</div></div>
          </div>
        </div>

        <div class="preview-section">
          <h3 class="section-title">ğŸ‘ï¸ PrevisualizaciÃ³n</h3>
          <div class="table-preview-wrapper">
            {# Si moviste el partial a /calificaciones/, usa la lÃ­nea de abajo #}
            {% include "calificaciones/_preview_table.html" %}
            {# Si no lo moviste, deja el include anterior que ya tenÃ­as #}
            {# {% include "sandbox/_preview_table.html" %} #}
          </div>
        </div>
      {% endif %}
    </div>

    <div class="modal-footer">
      <a href="{% url 'main' %}" class="btn-modal btn-cancel">âœ• Cancelar</a>

      {% if preview_rows %}
        {% if can_import %}
          <form method="post" action="{% url 'carga_archivo_confirmar' %}">
            {% csrf_token %}
            <button type="submit" class="btn-modal btn-import">ğŸ“¥ Importar Calificaciones</button>
          </form>
        {% else %}
          <button class="btn-modal btn-import" disabled title="Hay errores que resolver">ğŸ“¥ Importar Calificaciones</button>
        {% endif %}
      {% else %}
        <button class="btn-modal btn-validate" id="btnValidate" disabled>ğŸ” Validar Archivo</button>
      {% endif %}
    </div>

  </div>
</div>

<script>
  const uploadForm  = document.getElementById('uploadForm');
  const input       = document.getElementById('fileInput');
  const btnSelect   = document.getElementById('btnSelectFile');
  const zone        = document.getElementById('uploadZone');
  const btnRemove   = document.getElementById('btnRemoveFile');

  if (btnSelect) btnSelect.addEventListener('click', () => input.click());
  if (input) input.addEventListener('change', () => { if (input.files.length) uploadForm.submit(); });

  if (zone) {
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
    zone.addEventListener('drop', e => {
      e.preventDefault();
      input.files = e.dataTransfer.files;
      zone.classList.remove('drag-over');
      if (input.files.length) uploadForm.submit();
    });
  }
  if (btnRemove) btnRemove.addEventListener('click', () => { window.location.href = "{% url 'carga_archivo' %}"; });
</script>
{% endblock %}
