{% extends "base.html" %}
{% load static %}

{% block main %}
<div class="container my-4">

  <!-- ===========================================
       Encabezado / contexto de la calificaci√≥n
       =========================================== -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">
      Calificaci√≥n #{{ calif.pk }}
      <small class="text-muted">‚Äî {{ calif.instrumento_text }} ({{ calif.ejercicio }})</small>
    </h3>
    <div>
      <a href="{% url 'main' %}" class="btn btn-outline-secondary btn-sm">‚Üê Volver al Mantenedor</a>
    </div>
  </div>

  <!-- Metadatos √∫tiles (incluye fecha de √∫ltima modificaci√≥n) -->
  <div class="row g-3 mb-3">
    <div class="col-sm-6 col-md-3">
      <div class="small text-muted">Mercado</div>
      <div class="fw-semibold">{{ calif.mercado }}</div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="small text-muted">Tipo Ingreso</div>
      <div class="fw-semibold">{{ calif.tipo_ingreso }}</div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="small text-muted">Fecha Pago</div>
      <div class="fw-semibold">{{ calif.fecha_pago_dividendo }}</div>
    </div>
    <div class="col-sm-6 col-md-3">
      <div class="small text-muted">Secuencia Evento</div>
      <div class="fw-semibold">{{ calif.secuencia_evento }}</div>
    </div>
    {% if calif.fecha_modificacion %}
    <div class="col-12">
      <div class="alert alert-info py-2 mb-0">
        <small>
          <strong>üìÖ √öltima modificaci√≥n:</strong> {{ calif.fecha_modificacion|date:"d/m/Y H:i" }}
          {% if calif.usuario %}por {{ calif.usuario.get_full_name|default:calif.usuario.username }}{% endif %}
        </small>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- ===========================================
       Mensajes (√©xito / error / info)
       =========================================== -->
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'secondary' }} py-2 mb-2">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- ===========================================
       Selector de Modo de Ingreso
       =========================================== -->
  <div class="card shadow-sm mb-3">
    <div class="card-body py-2">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <strong>Modo de ingreso:</strong>
          <span class="text-muted small">Seleccione c√≥mo desea ingresar los datos</span>
        </div>
        <div class="btn-group" role="group">
          <input type="radio" class="btn-check" name="modo_ingreso" id="modo_montos" 
                 value="montos" {% if modo_ingreso == 'montos' or not modo_ingreso %}checked{% endif %}
                 onchange="cambiarModoIngreso('montos')">
          <label class="btn btn-outline-primary" for="modo_montos">
            üí∞ Ingresar Montos
          </label>

          <input type="radio" class="btn-check" name="modo_ingreso" id="modo_factores" 
                 value="factores" {% if modo_ingreso == 'factores' %}checked{% endif %}
                 onchange="cambiarModoIngreso('factores')">
          <label class="btn btn-outline-primary" for="modo_factores">
            üìä Ingresar Factores
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- ===========================================
       Formulario de MONTOS (posiciones 8..37)
       =========================================== -->
  <div id="formulario-montos" {% if modo_ingreso == 'factores' %}style="display: none;"{% endif %}>
    <form method="post" novalidate>
      {% csrf_token %}
      <input type="hidden" name="modo_ingreso" value="montos">

      <!-- Errores generales del formulario -->
      {% if montos_form.non_field_errors %}
        <div class="alert alert-danger">
          {{ montos_form.non_field_errors }}
        </div>
      {% endif %}

      <div class="card shadow-sm mb-3">
        <div class="card-header py-2">
          <strong>Montos por factor</strong>
          <span class="text-muted small d-block">Ingrese valores para posiciones 8..37. El denominador es la suma de 8..19.</span>
        </div>
        <div class="card-body p-0">

          <!-- Tabla de entrada de montos -->
          <div class="table-responsive">
            <table class="table table-sm m-0 align-middle table-hover">
              <thead class="table-light">
                <tr>
                  <th style="width: 55%;">Posici√≥n / Nombre del factor</th>
                  <th style="width: 25%;">Monto</th>
                  <th style="width: 20%;">Errores</th>
                </tr>
              </thead>
              <tbody>
                {% for field in montos_form %}
                  <tr>
                    <td>
                      <label class="form-label m-0">{{ field.label }}</label>
                      {% if field.help_text %}
                        <div class="form-text">{{ field.help_text }}</div>
                      {% endif %}
                    </td>
                    <td style="max-width: 260px;">{{ field }}</td>
                    <td class="text-danger small">
                      {% for err in field.errors %}‚Ä¢ {{ err }}<br>{% endfor %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
          <div>
            <!-- Bot√≥n para eliminar la calificaci√≥n completa -->
            <button type="submit" 
                    name="action" 
                    value="eliminar" 
                    class="btn btn-danger btn-sm"
                    onclick="return confirm('‚ö†Ô∏è ¬øEst√° seguro de eliminar PERMANENTEMENTE esta calificaci√≥n? Esta acci√≥n no se puede deshacer.')">
              üóëÔ∏è Eliminar Calificaci√≥n
            </button>
          </div>
          <div>
            <!-- Bot√≥n para cancelar edici√≥n sin guardar -->
            <button type="submit" 
                    name="action" 
                    value="cancelar" 
                    class="btn btn-outline-secondary btn-sm"
                    onclick="return confirm('‚ö†Ô∏è ¬øDescartar los cambios actuales?')">
              ‚ùå Cancelar
            </button>
          
            <button type="submit" 
                    name="action" 
                    value="calcular" 
                    class="btn btn-secondary btn-sm">
                üßÆ Calcular
            </button>
          
            <button type="submit" 
                    name="action" 
                    value="guardar" 
                    class="btn btn-primary btn-sm">
                üíæ Guardar Montos
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- ===========================================
       Formulario de FACTORES (ingreso manual)
       =========================================== -->
  <div id="formulario-factores"
     {% if modo_ingreso == 'factores' %}
       style="display: block;"
     {% else %}
       style="display: none;"
     {% endif %}>
  <form method="post" novalidate>
    {% csrf_token %}
    <input type="hidden" name="modo_ingreso" value="factores">


      <!-- Errores generales del formulario -->
      {% if factores_form.non_field_errors %}
        <div class="alert alert-danger">
          {{ factores_form.non_field_errors }}
        </div>
      {% endif %}

      <div class="card shadow-sm mb-3">
        <div class="card-header py-2">
          <strong>Factores por posici√≥n</strong>
          <span class="text-muted small d-block">Ingrese factores manualmente. La suma de factores 8..19 debe ser ‚â§ 1.00000000</span>
        </div>
        <div class="card-body p-0">

          <!-- Tabla de entrada de factores -->
          <div class="table-responsive">
            <table class="table table-sm m-0 align-middle table-hover">
              <thead class="table-light">
                <tr>
                  <th style="width: 55%;">Posici√≥n / Nombre del factor</th>
                  <th style="width: 25%;">Factor (8 decimales)</th>
                  <th style="width: 20%;">Errores</th>
                </tr>
              </thead>
              <tbody>
                {% for field in factores_form %}
                  <tr>
                    <td>
                      <label class="form-label m-0">{{ field.label }}</label>
                      {% if field.help_text %}
                        <div class="form-text">{{ field.help_text }}</div>
                      {% endif %}
                    </td>
                    <td style="max-width: 260px;">{{ field }}</td>
                    <td class="text-danger small">
                      {% for err in field.errors %}‚Ä¢ {{ err }}<br>{% endfor %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
          <div>
            <!-- Bot√≥n para eliminar la calificaci√≥n completa -->
            <button type="submit" 
                    name="action" 
                    value="eliminar" 
                    class="btn btn-danger btn-sm"
                    onclick="return confirm('‚ö†Ô∏è ¬øEst√° seguro de eliminar PERMANENTEMENTE esta calificaci√≥n? Esta acci√≥n no se puede deshacer.')">
              üóëÔ∏è Eliminar Calificaci√≥n
            </button>
          </div>
          <div>
            <!-- Bot√≥n para cancelar edici√≥n sin guardar -->
            <button type="submit" 
                    name="action" 
                    value="cancelar" 
                    class="btn btn-outline-secondary btn-sm"
                    onclick="return confirm('‚ö†Ô∏è ¬øDescartar los cambios actuales?')">
              ‚ùå Cancelar
            </button>
          
            <button type="submit" 
                    name="action" 
                    value="validar" 
                    class="btn btn-secondary btn-sm">
                ‚úì Validar Factores
            </button>
          
            <button type="submit" 
                    name="action" 
                    value="guardar" 
                    class="btn btn-primary btn-sm">
                üíæ Guardar Factores
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- ===========================================
       Resultados (s√≥lo visibles tras "Calcular" o validar)
       =========================================== -->
  {% if factores %}
    <div class="card shadow-sm">
      <div class="card-header py-2 {% if suma_valida %}bg-success text-white{% else %}bg-warning{% endif %}">
        <strong>Resultados {% if modo_ingreso == 'factores' %}de validaci√≥n{% else %}calculados{% endif %}</strong>
        <span class="small d-block">
          {% if modo_ingreso == 'montos' %}
            Total base (suma montos 8..19): {{ total }}
          {% endif %}
          Suma de factores 8..19: <strong>{{ suma_factores_8_19 }}</strong>
          {% if suma_valida %}
            ‚úÖ V√°lido
          {% else %}
            ‚ö†Ô∏è Excede el l√≠mite de 1.0
          {% endif %}
        </span>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm m-0 align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 8%;">Pos</th>
                <th>Nombre del factor</th>
                {% if modo_ingreso == 'montos' %}
                <th style="width: 20%;">Monto</th>
                {% endif %}
                <th style="width: 20%;">Factor</th>
              </tr>
            </thead>
            <tbody>
              {% for pos, row in factores.items %}
                <tr {% if pos >= 8 and pos <= 19 %}class="table-primary"{% endif %}>  
                  <td>{{ pos }}</td>
                  <td>{{ row.nombre }}</td>
                  {% if modo_ingreso == 'montos' %}
                  <td>{{ row.monto }}</td>
                  {% endif %}
                  <td>{{ row.factor }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer">
        <span class="small text-muted">
          Validaci√≥n: suma de factores 8..19 ‚â§ <code>1.00000000</code>.  
          Los factores se redondean a 8 decimales con HALF_UP.
        </span>
      </div>
    </div>
  {% endif %}

</div>

<script>
// Funci√≥n para cambiar el modo de ingreso (muestra/oculta formularios)
function cambiarModoIngreso(modo) {
  const formularioMontos = document.getElementById('formulario-montos');
  const formularioFactores = document.getElementById('formulario-factores');
  
  if (modo === 'montos') {
    formularioMontos.style.display = 'block';
    formularioFactores.style.display = 'none';
  } else if (modo === 'factores') {
    formularioMontos.style.display = 'none';
    formularioFactores.style.display = 'block';
  }
}

// Mantener el estado del modo despu√©s de recargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
  const modoMontos = document.getElementById('modo_montos');
  const modoFactores = document.getElementById('modo_factores');
  
  if (modoMontos && modoMontos.checked) {
    cambiarModoIngreso('montos');
  } else if (modoFactores && modoFactores.checked) {
    cambiarModoIngreso('factores');
  }
});
</script>

{% endblock %}