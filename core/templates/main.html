{% extends 'base.html' %}
{% load static %}

{% block title %}NUAM - Mantenedor de Calificaciones Tributarias{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">
{% endblock %}

{% block main %}
    <div class="header">
        <div class="logo">NUAM - Mantenedor de Calificaciones</div>
    </div>

    <div class="container">
        <!-- Mensajes de sistema (success, error, info) -->
        {% if messages %}
            <div class="mb-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Barra superior: filtros -->
        <form method="get" id="form-filtros">
            <div class="top-filters">
                <div class="filters-grid">
                    <!-- Filtro Tipo de Mercado -->
                    <div class="filter-item">
                        <label for="filtro-mercado">Tipo de Mercado:</label>
                        <select name="mercado" id="filtro-mercado" class="form-control form-control-sm">
                            <option value="">Todos los mercados...</option>
                            {% for mercado in mercados_disponibles %}
                                <option value="{{ mercado }}" {% if filtro_mercado == mercado %}selected{% endif %}>
                                    {{ mercado }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtro Tipo de Ingreso -->
                    <div class="filter-item">
                        <label for="filtro-tipo-ingreso">Tipo de Ingreso:</label>
                        <select name="tipo_ingreso" id="filtro-tipo-ingreso" class="form-control form-control-sm">
                            <option value="">Todos los tipos...</option>
                            {% for tipo in tipos_ingreso_disponibles %}
                                <option value="{{ tipo.nombre_tipo_ingreso }}" 
                                        {% if filtro_tipo_ingreso == tipo.nombre_tipo_ingreso %}selected{% endif %}>
                                    {{ tipo.nombre_tipo_ingreso }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtro Ejercicio (A√±o) -->
                    <div class="filter-item">
                        <label for="filtro-ejercicio">Ejercicio (A√±o):</label>
                        <select name="ejercicio" id="filtro-ejercicio" class="form-control form-control-sm">
                            <option value="">Todos los a√±os...</option>
                            {% for ejercicio in ejercicios_disponibles %}
                                <option value="{{ ejercicio }}" {% if filtro_ejercicio == ejercicio|stringformat:"s" %}selected{% endif %}>
                                    {{ ejercicio }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Botones de b√∫squeda y limpieza -->
                <div class="search-actions">
                    <button type="submit" class="btn btn-primary btn-sm">üîç BUSCAR</button>
                    <button type="button" id="btn-limpiar" class="btn btn-outline-secondary btn-sm">üóëÔ∏è LIMPIAR</button>
                </div>
            </div>
        </form>

        <!-- Tabla con scroll y datos reales -->
        <div class="data-table">
            <div class="table-wrapper">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="checkbox-all" class="form-check-input"></th>
                            <th>ID</th>
                            <th>Ejercicio</th>
                            <th>Mercado</th>
                            <th>Instrumento</th>
                            <th>Fecha Pago</th>
                            <th>Descripci√≥n</th>
                            <th>Secuencia Evento</th>
                            <th>Acogido ISFUT/ISIFT</th>
                            <th>Factor 8</th>
                            <th>Factor 9</th>
                            <th>Factor 10</th>
                            <th>Factor 11</th>
                            <th>Factor 12</th>
                            <th>Factor 13</th>
                            <th>Factor 14</th>
                            <th>Factor 15</th>
                            <th>Factor 16</th>
                            <th>Factor 17</th>
                            <th>Factor 18</th>
                            <th>Factor 19</th>
                            <th>Factor 20</th>
                            <th>Factor 21</th>
                            <th>Factor 22</th>
                            <th>Factor 23</th>
                            <th>Factor 24</th>
                            <th>Factor 25</th>
                            <th>Factor 26</th>
                            <th>Factor 27</th>
                            <th>Factor 28</th>
                            <th>Factor 29</th>
                            <th>Factor 30</th>
                            <th>Factor 31</th>
                            <th>Factor 32</th>
                            <th>Factor 33</th>
                            <th>Factor 34</th>
                            <th>Factor 35</th>
                            <th>Factor 36</th>
                            <th>Factor 37</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for it in items %}
                        <tr>
                            <td><input type="checkbox" class="form-check-input row-checkbox" data-id="{{ it.pk }}"></td>
                            <td class="fw-bold">{{ it.calificacion_id }}</td>
                            <td>{{ it.ejercicio }}</td>
                            <td><span class="badge bg-secondary">{{ it.mercado }}</span></td>
                            <td>{{ it.instrumento_text|default:"-" }}</td>
                            <td>{{ it.fecha_pago_dividendo|date:"d/m/Y" }}</td>
                            <td>{{ it.descripcion|truncatewords:5|default:"-" }}</td>
                            <td>{{ it.secuencia_evento }}</td>
                            <td>
                                {% if it.isfut %}
                                    <span class="badge bg-success">S√≠</span>
                                {% else %}
                                    <span class="badge bg-light text-dark">No</span>
                                {% endif %}
                            </td>
                            <!-- Factores 8-37 -->
                            <td>{{ it.factores_dict.8|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.9|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.10|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.11|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.12|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.13|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.14|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.15|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.16|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.17|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.18|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.19|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.20|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.21|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.22|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.23|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.24|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.25|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.26|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.27|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.28|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.29|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.30|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.31|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.32|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.33|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.34|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.35|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.36|floatformat:8|default:"-" }}</td>
                            <td>{{ it.factores_dict.37|floatformat:8|default:"-" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="39" class="text-center text-muted py-5">
                                <div class="mb-2">üì≠</div>
                                <p class="mb-1">No hay calificaciones registradas</p>
                                <small>Haz clic en "Ingresar" para crear una nueva calificaci√≥n</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Barra de acciones inferior -->
        <div class="action-bar">
            <div class="action-buttons">
                <button class="btn btn-danger" id="btn-eliminar" disabled>üóëÔ∏è Eliminar</button>
                <a href="{% url 'carga_masiva' %}" class="btn btn-secondary">üìÅ Carga Masiva</a>
                <a href="{% url 'carga_manual' %}" class="btn btn-success">‚ûï Ingresar</a>
                <button class="btn btn-primary" id="btn-modificar" disabled>‚úèÔ∏è Modificar</button>
            </div>
        </div>

        <!-- Footer con contador -->
        {% if items %}
        <div class="mt-3 text-muted small text-center">
            Mostrando {{ items|length }} calificaci√≥n{{ items|length|pluralize:"es" }}
        </div>
        {% endif %}
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxAll = document.getElementById('checkbox-all');
        const checkboxes = document.querySelectorAll('.row-checkbox');
        const btnEliminar = document.getElementById('btn-eliminar');
        const btnModificar = document.getElementById('btn-modificar');
        const btnLimpiar = document.getElementById('btn-limpiar');
        const formFiltros = document.getElementById('form-filtros');

        // ========================================
        // FILTROS
        // ========================================
        
        // Bot√≥n Limpiar: resetea todos los filtros
        if (btnLimpiar) {
            btnLimpiar.addEventListener('click', function() {
                // Limpiar todos los selects
                document.getElementById('filtro-mercado').value = '';
                document.getElementById('filtro-tipo-ingreso').value = '';
                document.getElementById('filtro-ejercicio').value = '';
                
                // Recargar la p√°gina sin par√°metros GET
                window.location.href = window.location.pathname;
            });
        }

        // Aplicar filtros autom√°ticamente al cambiar (opcional)
        const filtros = document.querySelectorAll('#filtro-mercado, #filtro-tipo-ingreso, #filtro-ejercicio');
        filtros.forEach(filtro => {
            filtro.addEventListener('change', function() {
                // Descomentar si quieres que filtre autom√°ticamente al cambiar
                // formFiltros.submit();
            });
        });

        // ========================================
        // SELECCI√ìN Y BOTONES DE ACCI√ìN
        // ========================================
        
        // Funci√≥n para actualizar estado de los botones
        function actualizarBotones() {
            const seleccionados = document.querySelectorAll('.row-checkbox:checked');
            const count = seleccionados.length;

            // Bot√≥n Eliminar: habilitado si hay al menos uno seleccionado
            if (count > 0) {
                btnEliminar.disabled = false;
                btnEliminar.textContent = `üóëÔ∏è Eliminar (${count})`;
            } else {
                btnEliminar.disabled = true;
                btnEliminar.textContent = 'üóëÔ∏è Eliminar';
            }

            // Bot√≥n Modificar: habilitado SOLO si hay EXACTAMENTE uno seleccionado
            if (count === 1) {
                btnModificar.disabled = false;
                const id = seleccionados[0].getAttribute('data-id');
                btnModificar.onclick = function() {
                    window.location.href = `/calificacion/edit/${id}/`;
                };
            } else {
                btnModificar.disabled = true;
                btnModificar.onclick = null;
                if (count > 1) {
                    btnModificar.title = 'Selecciona solo una calificaci√≥n para modificar';
                } else {
                    btnModificar.title = 'Selecciona una calificaci√≥n para modificar';
                }
            }

            // Actualizar checkbox principal
            if (checkboxes.length > 0) {
                const todosSeleccionados = Array.from(checkboxes).every(cb => cb.checked);
                const algunoSeleccionado = Array.from(checkboxes).some(cb => cb.checked);
                checkboxAll.checked = todosSeleccionados;
                checkboxAll.indeterminate = algunoSeleccionado && !todosSeleccionados;
            }
        }

        // Checkbox principal: seleccionar/deseleccionar todos
        if (checkboxAll) {
            checkboxAll.addEventListener('change', function() {
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                });
                actualizarBotones();
            });
        }

        // Checkboxes individuales
        checkboxes.forEach(cb => {
            cb.addEventListener('change', actualizarBotones);
        });

        // Bot√≥n Eliminar (implementar seg√∫n tus necesidades)
        btnEliminar.addEventListener('click', function() {
            const seleccionados = Array.from(document.querySelectorAll('.row-checkbox:checked'));
            
            if (seleccionados.length === 0) {
                alert('Selecciona al menos una calificaci√≥n para eliminar');
                return;
            }

            const mensaje = seleccionados.length === 1 
                ? '¬øEst√°s seguro de eliminar esta calificaci√≥n?' 
                : `¬øEst√°s seguro de eliminar ${seleccionados.length} calificaciones?`;
            
            if (confirm(mensaje)) {
                // TODO: Implementar eliminaci√≥n
                alert('Funci√≥n de eliminaci√≥n pendiente de implementar');
            }
        });

        // Inicializar estado de botones
        actualizarBotones();

        // ========================================
        // INDICADOR VISUAL DE FILTROS ACTIVOS
        // ========================================
        
        // Mostrar badge con cantidad de filtros activos
        function mostrarFiltrosActivos() {
            const filtrosActivos = [];
            
            if (document.getElementById('filtro-mercado').value) {
                filtrosActivos.push('Mercado');
            }
            if (document.getElementById('filtro-tipo-ingreso').value) {
                filtrosActivos.push('Tipo Ingreso');
            }
            if (document.getElementById('filtro-ejercicio').value) {
                filtrosActivos.push('Ejercicio');
            }
            
            if (filtrosActivos.length > 0) {
                // Crear badge si no existe
                let badge = document.querySelector('.filtros-activos-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'badge bg-info filtros-activos-badge ms-2';
                    document.querySelector('.logo').appendChild(badge);
                }
                badge.textContent = `${filtrosActivos.length} filtro(s) activo(s): ${filtrosActivos.join(', ')}`;
            } else {
                // Remover badge si existe
                const badge = document.querySelector('.filtros-activos-badge');
                if (badge) {
                    badge.remove();
                }
            }
        }
        
        mostrarFiltrosActivos();
    });
    </script>
{% endblock %}